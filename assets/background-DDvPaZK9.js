import{b as dt,a as W,c as K,d as ft,O as l,g as E}from"./getPluginId-CxRP2hJM.js";import{M as x,m as j}from"./menuIcon-BywqSbDq.js";import{i as q,g as Tt}from"./itemMetadataHelpers-C1JOvmed.js";import{g as $,a as ut,N as Y}from"./getGlobalSettings-C1KsdlI9.js";import"./itemMetadataIds-Chv2A94E.js";import"./metadataHelpers-DJltngHl.js";import"./settingMetadataHelpers-B1IUCCwG.js";function pt(t,o,e=0){return t<=0?0:t>=o?1:e===0?t/o:Math.ceil(t/o*e)/e}function z(t,o,e,n=1,a=10){if(e*2>o&&(e=o*.5),n>=1)return[{x:e,y:0},{x:t-e,y:0},...p({x:t-e,y:e},e,Math.PI*.5,-Math.PI*.5,a),...p({x:t-e,y:o-e},e,0,-Math.PI*.5,a),{x:t-e,y:o},{x:0+e,y:o},...p({x:e,y:o-e},e,-Math.PI*.5,-Math.PI*.5,a),...p({x:e,y:e},e,-Math.PI,-Math.PI*.5,a)];const r=n*t;if(r<e){const i=Math.acos((e-r)/e);return[...p({x:e,y:o-e},e,Math.PI+i,-i,a),...p({x:e,y:e},e,Math.PI,-i,a)]}const s=t-r;if(s<e){const i=Math.acos((e-s)/e);return[{x:e,y:0},{x:t-e,y:0},...p({x:t-e,y:e},e,Math.PI*.5,-Math.PI*.5+i,a),...p({x:t-e,y:o-e},e,-i,-Math.PI*.5+i,a),{x:t-e,y:o},{x:e,y:o},...p({x:e,y:o-e},e,-Math.PI*.5,-Math.PI*.5,a),...p({x:e,y:e},e,-Math.PI,-Math.PI*.5,a)]}return[{x:e,y:0},{x:r,y:0},{x:r,y:o},{x:e,y:o},...p({x:e,y:o-e},e,-Math.PI*.5,-Math.PI*.5,a),...p({x:e,y:e},e,-Math.PI,-Math.PI*.5,a)]}function p(t,o,e,n,a){a--;const r=[],s=n/a;let i=e;for(let h=0;h<=a;h++)r.push({x:t.x+o*Math.cos(i),y:t.y-o*Math.sin(i)}),i+=s;return r}function At(t,o,e){const n=gt(o,e);n.width=Math.abs(n.width),n.height=Math.abs(n.height);const a=bt(o,e);return{origin:{x:a.x,y:a.y+(t.barAtTop?-1:1)*n.height/2-t.verticalOffset+(t.barAtTop?1:0)},bounds:n}}function gt(t,o){const e=o/t.grid.dpi,n=t.image.width*e*t.scale.x,a=t.image.height*e*t.scale.y;return{width:n,height:a}}function bt(t,o){let e={x:0,y:0};return e=x.add(e,x.multiply({x:t.image.width,y:t.image.height},.5)),e=x.subtract(e,t.grid.offset),e=x.multiply(e,o/t.grid.dpi),e=x.multiply(e,t.scale),e=x.rotate(e,{x:0,y:0},t.rotation),e=x.add(e,t.position),e}const Q=22,U="Roboto, sans-serif",R=!0,H=!0,V=.6,S=["ROTATION","VISIBLE","COPY","SCALE"],tt=-.3,et=.95,T=30,xt=T-8,It=T-15,Et=T+0;function F(t,o,e,n,a,r){const s=ft().width(T).height(T).shapeType("CIRCLE").fillColor(e).fillOpacity(V).strokeColor(e).strokeOpacity(.5).strokeWidth(0).position({x:n.x,y:n.y}).attachedTo(t.id).layer("ATTACHMENT").locked(R).id(a).visible(t.visible).disableAttachmentBehavior(S).disableHit(H).build(),i=o.toString(),h=K().position({x:n.x-T/2,y:n.y-T/2+tt+.8}).plainText(i.length>3?"â€¦":i).textAlign("CENTER").textAlignVertical("MIDDLE").fontSize(i.length===3?It:xt).fontFamily(U).textType("PLAIN").height(Et).width(T).fontWeight(400).attachedTo(t.id).layer("TEXT").locked(R).lineHeight(et).id(r).visible(t.visible).disableAttachmentBehavior(S).disableHit(H).build();return[s,h]}const X=2,Mt=.5,P=20,nt=12,J=P/2;function Z(t,o,e,n,a,r,s="full",i=0){let h;s==="short"?h=nt:h=P;const y={x:r.x-o.width/2+X,y:r.y-h-2},b=o.width-X*2,A=h+0,w=t.visible;let O="#A4A4A4";a||(O="black");const B=W().fillColor(O).fillOpacity(V).position({x:y.x,y:y.y}).zIndex(1e4).attachedTo(t.id).layer("ATTACHMENT").locked(R).id(st(t.id)).visible(w).disableAttachmentBehavior(S).disableHit(H).strokeWidth(0).tension(0).closed(!0).points(z(b,h,J)).build(),u=pt(e,n,i),g=W().fillColor("red").fillOpacity(Mt).zIndex(2e4).position({x:y.x,y:y.y}).strokeWidth(0).strokeOpacity(0).attachedTo(t.id).layer("ATTACHMENT").locked(R).id(at(t.id)).visible(w).disableAttachmentBehavior(S).disableHit(H).tension(0).closed(!0).points(z(b,h,J,u)).build();if(s==="short")return[B,g];const m=K().position({x:y.x,y:y.y+tt}).plainText(`${e}/${n}`).textAlign("CENTER").textAlignVertical("TOP").fontSize(Q).fontFamily(U).textType("PLAIN").height(A).width(b).fontWeight(400).attachedTo(t.id).fillOpacity(1).layer("TEXT").lineHeight(et).locked(R).id(C(t.id)).visible(w).disableAttachmentBehavior(S).disableHit(H).build();return[B,g,m]}function Rt(t,o,e,n,a){return[dt().maxViewScale(1).minViewScale(1).position(n).plainText(e).fontSize(Q).fontFamily(U).fontWeight(400).pointerHeight(0).pointerDirection(a).attachedTo(t.id).fillOpacity(.87).layer("TEXT").cornerRadius(o/12).padding(o/50).backgroundOpacity(V).locked(R).id(ot(t.id)).visible(t.visible).disableAttachmentBehavior(S).disableHit(H).build()]}const ot=t=>`${t}-name-tag`,C=t=>`${t}-health-text`,at=t=>`${t}-health-fill`,st=t=>`${t}-health-background`,it=t=>`${t}-ac-text`,ct=t=>`${t}-ac-background`,lt=t=>`${t}-temp-hp-text`,rt=t=>`${t}-temp-hp-background`;function _(t,o){t.push(C(o),at(o),st(o))}function D(t,o){t.push(it(o),ct(o))}function k(t,o){t.push(lt(o),rt(o))}function Ht(t,o){t.push(ot(o))}const St=40,wt=84,Pt=50,Ot=2;async function N(t,o){let e=wt+Ot;t.nameTags&&(e+=St),Bt(o,e),mt(o,e+Pt)}function Bt(t,o){l.contextMenu.create({id:E("player-menu"),icons:[{icon:j,label:"Edit Stats",filter:{every:[{key:"type",value:"IMAGE"},{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"MOUNT"},{key:["metadata","com.owlbear-rodeo-bubbles-extension/metadata","hide"],value:!0,operator:"!="}],permissions:["UPDATE"],roles:["PLAYER"],max:1}}],shortcut:"Shift + S",embed:{url:`contextMenu.html?themeMode=${t}`,height:o}})}function mt(t,o){l.contextMenu.create({id:E("gm-menu"),icons:[{icon:j,label:"Edit Stats",filter:{every:[{key:"type",value:"IMAGE"},{key:"layer",value:"CHARACTER",coordinator:"||"},{key:"layer",value:"MOUNT"}],roles:["GM"],max:1}}],shortcut:"Shift + S",embed:{url:`contextMenu.html?themeMode=${t}`,height:o}})}let d=[];const I=[],f=[];let c={verticalOffset:0,barAtTop:!1,showBars:!1,segments:0,nameTags:!1},L=!1,G,M;async function Nt(){const t=async()=>{c=(await $(c)).settings,M=(await l.theme.getTheme()).mode,N(c,M),await v(),await vt()};l.scene.onReadyChange(async e=>{e&&t()}),await l.scene.isReady()&&t()}async function v(){const t=await l.scene.items.getItems(a=>(a.layer==="CHARACTER"||a.layer==="MOUNT")&&q(a));d=t;const o=await l.player.getRole(),e=await l.scene.grid.getDpi();for(const a of t)ht(a,o,e);await yt(I,f);const n=[];for(const a of t)n.push(a.id)}async function vt(){if(!L){L=!0;const t=l.theme.onChange(s=>{M=s.mode,N(c,M)});G=await l.player.getRole();const o=l.player.onChange(async()=>{const s=await l.player.getRole();s!==G&&(v(),G=s)}),e=l.scene.onMetadataChange(async s=>{const{settings:i,isChanged:h}=await $(c,s);c=i,h&&(N(c,M),v())}),n=l.room.onMetadataChange(async s=>{const{settings:i,isChanged:h}=await $(c,void 0,s);c=i,h&&(N(c,M),v())}),a=l.scene.items.onChange(async s=>{const i=[];for(const A of s)(A.layer==="CHARACTER"||A.layer==="MOUNT")&&q(A)&&i.push(A);const h=Ct(i);d=i;const y=await l.player.getRole(),b=await l.scene.grid.getDpi();for(const A of h)ht(A,y,b);await yt(I,f)}),r=l.scene.onReadyChange(s=>{s||(t(),o(),e(),n(),a(),r(),L=!1)})}}function Ct(t){const o=[];let e=0;for(let n=0;n<t.length;n++)n>d.length-e-1?o.push(t[n]):d[n+e].id!==t[n].id?(e++,n--):d[n+e].scale.x===t[n].scale.x&&d[n+e].scale.y===t[n].scale.y&&(d[n+e].name===t[n].name||!c.nameTags)?d[n+e].position.x===t[n].position.x&&d[n+e].position.y===t[n].position.y&&d[n+e].grid.offset.x===t[n].grid.offset.x&&d[n+e].grid.offset.y===t[n].grid.offset.y&&d[n+e].grid.dpi===t[n].grid.dpi&&d[n+e].visible===t[n].visible&&JSON.stringify(d[n+e].metadata[E("metadata")])===JSON.stringify(t[n].metadata[E("metadata")])&&JSON.stringify(d[n+e].metadata[E(Y)])===JSON.stringify(t[n].metadata[E(Y)])||o.push(t[n]):(f.push(C(t[n].id)),o.push(t[n]));return o}function ht(t,o,e){const{origin:n,bounds:a}=At(c,t,e),[r,s,i,h,y]=Tt(t);if(o==="PLAYER"&&!y&&!c.showBars)_(f,t.id),D(f,t.id),k(f,t.id);else if(o==="PLAYER"&&!y&&c.showBars)A();else{const u=w(),g=O(u);B(u,g)}const b=ut(t);if(c.nameTags&&b!==""){const u={x:n.x,y:n.y};c.barAtTop&&(s<=0||o==="PLAYER"&&!y&&!c.showBars?u.y=n.y-4:o==="PLAYER"&&!y&&c.showBars?u.y=n.y-nt-4:u.y=n.y-P-4),I.push(...Rt(t,e,b,u,c.barAtTop?"DOWN":"UP"))}else Ht(f,t.id);function A(){if(f.push(C(t.id)),D(f,t.id),k(f,t.id),s<=0){_(f,t.id);return}f.push(`${t.id}health-label`),I.push(...Z(t,a,r,s,y,n,"short",c.segments))}function w(){return s<=0?(_(f,t.id),!1):(I.push(...Z(t,a,r,s,y,n)),!0)}function O(u){if(h<=0)return D(f,t.id),!1;const g={x:n.x+a.width/2-T/2-2,y:n.y-T/2-4-(u?P:0)};return c.barAtTop&&(g.y=n.y+T/2),I.push(...F(t,h,"cornflowerblue",g,ct(t.id),it(t.id))),!0}function B(u,g){if(i<=0){k(f,t.id);return}const m={x:n.x+a.width/2-T*(g?1.5:.5)-4,y:n.y-T/2-4-(u?P:0)};c.barAtTop&&(m.y=n.y+T/2),I.push(...F(t,i,"olivedrab",m,rt(t.id),lt(t.id)))}}async function yt(t,o){await l.scene.local.deleteItems(o),await l.scene.local.addItems(t),o.length=0,t.length=0}l.onReady(async()=>{_t(),Nt()});function _t(){fetch("/manifest.json").then(t=>t.json()).then(t=>console.log(t.name+" - version: "+t.version))}
